{
  "Name": "ShowNormals",
  "_id": "b6251010-daf1-4ce8-a0cb-3a40a8c6c7a5",
  "Namespace": "lib.mesh.modify",
  "Description": "",
  "Inputs": [
    {
      "Name": "Code",
      "MetaInstanceID": "71efc7b2-cd07-4107-8490-c6dccf8d9923",
      "DefaultValue": {
        "Type": "Text",
        "Value": [
          "//>>> _parameters\r",
          "float Length;",
          "float Width;",
          "float Show;",
          "//<<< _parameters\r",
          "\r",
          "struct Vertex\r",
          "{\r",
          "    float4 pos : POSITION;\r",
          "    float3 normal : NORMAL;\r",
          "    float4 col : COLOR;\r",
          "    float2 texCoord : TEXCOORD0;\r",
          "    float3 tangent : TANGENT0;\r",
          "    float3 binormal : BINORMAL0;\r",
          "};\r",
          "\r",
          "\r",
          "\r",
          "float Lerp(float a, float b, float t)\r",
          "{\r",
          "    return a + t*(b - a);\r",
          "}\r",
          "\r",
          "Vertex VertexMain(Vertex input)\r",
          "{\r",
          "    return input;\r",
          "}\r",
          "\r",
          "\r",
          "\r",
          "[maxvertexcount(9)]\r",
          "void GeometryMain(triangle Vertex input[3], inout TriangleStream<Vertex> outputStream)\r",
          "{   \r",
          "\r",
          "    float3 p0 = input[0].pos;\r",
          "    float3 p1 = input[1].pos;\r",
          "    float3 p2 = input[2].pos;\r",
          "    \r",
          "    float3 n0, n1,n2;\r",
          "    if(Show < 0.5) {\r",
          "        n0 =  input[0].normal;\r",
          "        n1 =  input[1].normal;\r",
          "        n2 =  input[2].normal;\r",
          "    }\r",
          "    else if(Show < 1.5) {\r",
          "        n0 =  input[0].tangent;\r",
          "        n1 =  input[1].tangent;\r",
          "        n2 =  input[2].tangent;\r",
          "    }\r",
          "    else {\r",
          "        n0 =  input[0].binormal;\r",
          "        n1 =  input[1].binormal;\r",
          "        n2 =  input[2].binormal;\r",
          "    }\r",
          "    \r",
          "    \r",
          "    float3 pc = (p0 + p1 + p2) / 3;\r",
          "    \r",
          "    Vertex v0 = input[0];\r",
          "    Vertex v1 = input[0];\r",
          "    Vertex v2 = input[0];\r",
          "        \r",
          "    v0.pos.xyz = p0;\r",
          "    v1.pos.xyz = p0 + n0 * Length;\r",
          "    v2.pos.xyz = p0 + normalize(pc - p0) * Width * Length;\r",
          "    \r",
          "    outputStream.Append( v0 );\r",
          "    outputStream.Append( v1 );\r",
          "    outputStream.Append( v2 );\r",
          "    outputStream.RestartStrip();\r",
          "\r",
          "\r",
          "    v0.pos.xyz = p1;\r",
          "    v1.pos.xyz = p1 + n1 * Length;\r",
          "    v2.pos.xyz = p1 + normalize(pc - p1) * Width * Length;\r",
          "    \r",
          "    outputStream.Append( v0 );\r",
          "    outputStream.Append( v1 );\r",
          "    outputStream.Append( v2 );\r",
          "    outputStream.RestartStrip();\r",
          "\r",
          "    v0.pos.xyz = p2;\r",
          "    v1.pos.xyz = p2 + n2 * Length ;\r",
          "    v2.pos.xyz = p2 + normalize(pc - p2) * Width * Length;\r",
          "    \r",
          "    outputStream.Append( v0 );\r",
          "    outputStream.Append( v1 );\r",
          "    outputStream.Append( v2 );\r",
          "    outputStream.RestartStrip();\r",
          "};\r",
          "\r",
          "\r",
          "GeometryShader pGSComp = CompileShader(gs_5_0, GeometryMain());\r",
          "GeometryShader pGSwSO = ConstructGSWithSO(pGSComp, \"POSITION; NORMAL.xyz; COLOR; TEXCOORD0.xy; TANGENT0.xyz; BINORMAL0.xyz\", NULL, NULL, NULL, 0);\r",
          "\r",
          "\r",
          "technique11 Render\r",
          "{\r",
          "    pass \r",
          "    {\r",
          "        SetVertexShader(CompileShader(vs_5_0, VertexMain()));\r",
          "        SetGeometryShader(pGSwSO);\r",
          "        SetPixelShader(NULL);\r",
          "    }\r",
          "}\r",
          "\r",
          ""
        ]
      },
      "MetaID": "c522a66e-3260-4692-b3e3-79fd0361fa3d",
      "IsMultiInput": "False",
      "Relevance": "Optional",
      "Description": "",
      "Min": "-100000",
      "Max": "100000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": []
    },
    {
      "Name": "Length",
      "MetaInstanceID": "18d72017-3369-4cab-8467-37eb494c8a2a",
      "DefaultValue": {
        "Type": "Float",
        "Value": "1"
      },
      "MetaID": "3f76dee3-3897-44ac-82d6-25ce9f53a506",
      "IsMultiInput": "False",
      "Relevance": "Optional",
      "Description": "",
      "Min": "-10000",
      "Max": "10000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": []
    },
    {
      "Name": "Mesh",
      "MetaInstanceID": "c7decfd3-e1b4-4ea6-891d-d847bc40bbd1",
      "DefaultValue": {
        "Type": "Mesh",
        "Value": "Framefield.Core.MeshValue"
      },
      "MetaID": "cc257632-61ce-4950-acf1-8a25fa3e2206",
      "IsMultiInput": "False",
      "Relevance": "Required",
      "Description": "",
      "Min": "-100000",
      "Max": "100000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": []
    },
    {
      "Name": "Width",
      "MetaInstanceID": "59b92dd3-02fc-49ea-9fc3-08bc6450d2a3",
      "DefaultValue": {
        "Type": "Float",
        "Value": "0.05"
      },
      "MetaID": "3f76dee3-3897-44ac-82d6-25ce9f53a506",
      "IsMultiInput": "False",
      "Relevance": "Optional",
      "Description": "",
      "Min": "-10000",
      "Max": "10000",
      "Scale": "0.01",
      "ScaleType": "Linear",
      "EnumValues": []
    },
    {
      "Name": "Show",
      "MetaInstanceID": "2770b5a4-7b63-4dce-9148-d4035350ee7a",
      "DefaultValue": {
        "Type": "Float",
        "Value": "0"
      },
      "MetaID": "3f76dee3-3897-44ac-82d6-25ce9f53a506",
      "IsMultiInput": "False",
      "Relevance": "Optional",
      "Description": "",
      "Min": "-10000",
      "Max": "10000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": [
        {
          "Name": "Normal",
          "Value": "0"
        },
        {
          "Name": "Tangent",
          "Value": "1"
        },
        {
          "Name": "Binormal",
          "Value": "2"
        }
      ]
    }
  ],
  "Outputs": [
    {
      "Name": "Scene",
      "MetaInstanceID": "e9e43347-aa79-4022-8296-6ef9cb1b8902",
      "MetaID": "cc257632-61ce-4950-acf1-8a25fa3e2206"
    }
  ],
  "OperatorParts": [
    {
      "MetaInstanceID": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee",
      "MetaID": "a68ade13-a2fd-4f18-ac4f-8480e065fb75",
      "Name": "ShowNormalsFunc",
      "Version": "f9ff7a90-8787-460e-b9f5-aeb2f60c6d63",
      "Type": "Float",
      "IsMultiInput": "True",
      "Script": [
        "//>>> _using",
        "using System;",
        "using System.Collections.Generic;",
        "using System.Linq;",
        "using System.Text;",
        "using SharpDX;",
        "using SharpDX.Direct3D11;",
        "using SharpDX.Windows;",
        "//<<< _using",
        "using Framefield.Core.OperatorPartTraits;",
        "using Framefield.Core.Rendering;",
        "using Buffer = SharpDX.Direct3D11.Buffer;",
        "using SharpDX.Direct3D;",
        "",
        "namespace Framefield.Core.IDa68ade13_a2fd_4f18_ac4f_8480e065fb75",
        "{",
        "    public class Class_ShowNormals : FXSourceCodeFunction, IFXSceneSourceCode",
        "    {",
        "        //>>> _inputids",
        "        private enum InputId",
        "        {",
        "            Code = 0,",
        "            Length = 1,",
        "            Mesh = 2,",
        "            Width = 3,",
        "            Show = 4",
        "        }",
        "        //<<< _inputids",
        "",
        "        public Class_ShowNormals()",
        "        {",
        "        }",
        "",
        "        public override void Dispose() ",
        "        {",
        "            Utilities.DisposeObj(ref _mesh);",
        "            base.Dispose();",
        "        }",
        "",
        "        public override OperatorPartContext Eval(OperatorPartContext context, List<OperatorPart> inputs, int outputIdx)",
        "        {",
        "            try",
        "            {",
        "                UpdateMesh(context, inputs);",
        "                context.Mesh = _mesh;",
        "            }",
        "            catch (Exception exception)",
        "            {",
        "                Logger.Error(this, \"Load Effect error: {0}\", exception.Message);",
        "            }",
        "",
        "            return context;",
        "        }",
        "",
        "        bool _firstEval = true;",
        "        private void UpdateMesh(OperatorPartContext context, List<OperatorPart> inputs)",
        "        {",
        "            if (_firstEval)",
        "            {",
        "                for (int i = 0; i < NumCodes(); ++i)",
        "                    Compile(i);",
        "                _firstEval = false;",
        "                Changed = true;",
        "            }",
        "",
        "            if (!Changed && _mesh.Vertices != null)",
        "                return;",
        "",
        "            //>>> _params",
        "            var Code = inputs[(int)InputId.Code].Eval(context).Text;",
        "            var Length = inputs[(int)InputId.Length].Eval(context).Value;",
        "            var Mesh = inputs[(int)InputId.Mesh].Eval(context).Mesh;",
        "            var Width = inputs[(int)InputId.Width].Eval(context).Value;",
        "            var Show = (int) inputs[(int)InputId.Show].Eval(context).Value;",
        "            //<<< _params",
        "",
        "            const int VERTICES_PER_TRIANGLE = 3;",
        "            ",
        "            if (Mesh == null)",
        "                return;",
        "",
        "            _mesh.AttributesSize = Mesh.AttributesSize;",
        "            _mesh.NumTriangles = Mesh.NumTriangles * 3;",
        "            _mesh.InputElements = Mesh.InputElements;",
        "            if (_mesh.Vertices == null || _mesh.Vertices.Description.SizeInBytes != Mesh.Vertices.Description.SizeInBytes)",
        "            {",
        "                if (_mesh.Vertices != null)",
        "                    _mesh.Vertices.Dispose();",
        "",
        "                _mesh.Vertices = new Buffer(D3DDevice.Device, new BufferDescription()",
        "                                                                    {",
        "                                                                        BindFlags = BindFlags.StreamOutput | BindFlags.VertexBuffer,",
        "                                                                        CpuAccessFlags = CpuAccessFlags.None,",
        "                                                                        OptionFlags = ResourceOptionFlags.None,",
        "                                                                        SizeInBytes = _mesh.NumTriangles*Mesh.AttributesSize*3,",
        "                                                                        Usage = ResourceUsage.Default",
        "                                                                    });",
        "            }",
        "            ",
        "",
        "            ",
        "            _effect.GetVariableByName(\"Width\").AsScalar().Set(Width);",
        "            _effect.GetVariableByName(\"Length\").AsScalar().Set(Length);",
        "            _effect.GetVariableByName(\"Show\").AsScalar().Set(Show);",
        "",
        "            context.D3DDevice.ImmediateContext.StreamOutput.SetTargets(new [] { new StreamOutputBufferBinding(_mesh.Vertices, 0) });",
        "            context.D3DDevice.ImmediateContext.OutputMerger.DepthStencilState = new DepthStencilState(context.D3DDevice,",
        "                                                                                                        new DepthStencilStateDescription()",
        "                                                                                                            {",
        "                                                                                                                IsDepthEnabled = false,",
        "                                                                                                                IsStencilEnabled = false",
        "                                                                                                            });",
        "            context.D3DDevice.ImmediateContext.InputAssembler.InputLayout = context.InputLayout;",
        "            context.D3DDevice.ImmediateContext.InputAssembler.PrimitiveTopology = PrimitiveTopology.TriangleList;",
        "            context.D3DDevice.ImmediateContext.InputAssembler.SetVertexBuffers(0, new VertexBufferBinding(Mesh.Vertices, Mesh.AttributesSize, 0));",
        "            var technique = _effect.GetTechniqueByIndex(0);",
        "            technique.GetPassByIndex(0).Apply(context.D3DDevice.ImmediateContext);",
        "            context.D3DDevice.ImmediateContext.Draw(_mesh.NumTriangles*3, 0);",
        "            context.D3DDevice.ImmediateContext.StreamOutput.SetTargets(new [] { new StreamOutputBufferBinding(null, 0) });",
        "",
        "            Changed = false;",
        "        }",
        "",
        "        private Mesh _mesh = new Mesh();",
        "    }",
        "}",
        "",
        "",
        ""
      ],
      "AdditionalAssemblies": []
    }
  ],
  "Operators": [],
  "Connections": [
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "e9e43347-aa79-4022-8296-6ef9cb1b8902"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "71efc7b2-cd07-4107-8490-c6dccf8d9923",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "18d72017-3369-4cab-8467-37eb494c8a2a",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "c7decfd3-e1b4-4ea6-891d-d847bc40bbd1",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "59b92dd3-02fc-49ea-9fc3-08bc6450d2a3",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "2770b5a4-7b63-4dce-9148-d4035350ee7a",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "c8ebccbc-c1ca-4c4b-a0fd-a78329b020ee"
    }
  ]
}