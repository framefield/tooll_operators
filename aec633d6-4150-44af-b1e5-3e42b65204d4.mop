{
  "Name": "CubeMapper",
  "_id": "aec633d6-4150-44af-b1e5-3e42b65204d4",
  "Namespace": "lib.3d.material",
  "Description": "",
  "Inputs": [
    {
      "Name": "Code",
      "MetaInstanceID": "1a8f4e48-1da1-46bc-ae14-91d076706655",
      "DefaultValue": {
        "Type": "Text",
        "Value": [
          "float4x4 worldToCameraMatrix;\r",
          "float4x4 objectToWorldMatrix;\r",
          "float4x4 projMatrix;\r",
          "float4x4 textureMatrix;\r",
          "\r",
          "Texture2D txDiffuse;\r",
          "TextureCube CubeMap;\r",
          "\r",
          "SamplerState samLinear\r",
          "{\r",
          "    Filter = MIN_MAG_MIP_LINEAR;\r",
          "    AddressU = Wrap;\r",
          "    AddressV = Wrap;\r",
          "};\r",
          "\r",
          "struct VS_IN\r",
          "{\r",
          "    float4 pos : POSITION;\r",
          "    float3 normal: NORMAL;\r",
          "    float4 col : COLOR;\r",
          "    float2 texCoord : TEXCOORD;\r",
          "    float3 tangent: TANGENT;\r",
          "    float3 binormal: BINORMAL;\r",
          "};\r",
          "\r",
          "struct PS_IN\r",
          "{\r",
          "    float4 pos : SV_POSITION;\r",
          "    float4 col : COLOR;\r",
          "    float3 normal : NORMAL;\r",
          "    float2 texCoord: TEXCOORD0;\r",
          "};\r",
          "\r",
          "PS_IN VS( VS_IN input )\r",
          "{\r",
          "    PS_IN output = (PS_IN)0;\r",
          "\r",
          "    output.pos = mul(input.pos, objectToWorldMatrix);\r",
          "    output.pos = mul(output.pos, worldToCameraMatrix);\r",
          "    output.pos = mul(output.pos, projMatrix);\r",
          "    output.normal = mul(input.normal, (float3x3)objectToWorldMatrix);\r",
          "    output.col = input.col;\r",
          "    output.texCoord = mul(float4(input.texCoord.xy, 0, 1), textureMatrix).xy;\r",
          "\r",
          "    return output;\r",
          "}\r",
          "\r",
          "float4 PS( PS_IN input ) : SV_Target\r",
          "{\r",
          "    return CubeMap.Sample(samLinear, normalize(input.normal))*input.col;\r",
          "}\r",
          "\r",
          "technique10 Render\r",
          "{\r",
          "    pass P0\r",
          "    {\r",
          "        SetGeometryShader( 0 );\r",
          "        SetVertexShader( CompileShader( vs_4_0, VS() ) );\r",
          "        SetPixelShader( CompileShader( ps_4_0, PS() ) );\r",
          "    }\r",
          "}\r",
          ""
        ]
      },
      "MetaID": "c522a66e-3260-4692-b3e3-79fd0361fa3d",
      "IsMultiInput": "False",
      "Relevance": "Optional",
      "Description": "",
      "Min": "-100000",
      "Max": "100000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": []
    },
    {
      "Name": "Scene",
      "MetaInstanceID": "60743440-8ff4-4d82-8f17-789589dbd867",
      "DefaultValue": {
        "Type": "Scene",
        "Value": "Framefield.Core.Scene"
      },
      "MetaID": "79122951-7bc4-4c68-b085-866eab828248",
      "IsMultiInput": "False",
      "Relevance": "Required",
      "Description": "",
      "Min": "-100000",
      "Max": "100000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": []
    },
    {
      "Name": "CubeMap",
      "MetaInstanceID": "5a42be40-93c0-4a0d-9bf8-000ad6f0610f",
      "DefaultValue": {
        "Type": "Image",
        "Value": "Framefield.Core.Image"
      },
      "MetaID": "9848060d-fd84-45b0-b658-d0d531c61dab",
      "IsMultiInput": "False",
      "Relevance": "Required",
      "Description": "",
      "Min": "-100000",
      "Max": "100000",
      "Scale": "0.1",
      "ScaleType": "Linear",
      "EnumValues": []
    }
  ],
  "Outputs": [
    {
      "Name": "Scene",
      "MetaInstanceID": "7398945f-1172-4fb5-bda7-2c74df79a43c",
      "MetaID": "79122951-7bc4-4c68-b085-866eab828248"
    }
  ],
  "OperatorParts": [
    {
      "MetaInstanceID": "edfd87d5-f071-4e5f-9a93-253cf3b69a33",
      "MetaID": "0e49b045-1a1a-453f-941f-29bb86c7793e",
      "Name": "CubeMapperFunc",
      "Version": "517fb990-af05-4d8e-876e-ca0e42f8450e",
      "Type": "Float",
      "IsMultiInput": "True",
      "Script": [
        "//>>> _using",
        "using System;",
        "using System.Collections.Generic;",
        "using System.Linq;",
        "using System.Text;",
        "using SharpDX;",
        "using SharpDX.Direct3D11;",
        "using SharpDX.Windows;",
        "//<<< _using",
        "using Framefield.Core.Rendering;",
        "",
        "namespace Framefield.Core.ID0e49b045_1a1a_453f_941f_29bb86c7793e",
        "{",
        "    public class Class_CubeMapper : FXSourceCodeFunction, IFXSceneSourceCode",
        "    {",
        "",
        "        class Renderer : BaseRenderer",
        "        {",
        "        }",
        "",
        "        public override void Dispose() {",
        "            Utilities.DisposeObj(ref _renderer);",
        "            base.Dispose();",
        "        }",
        "",
        "        //>>> _inputids",
        "        private enum InputId",
        "        {",
        "            Code = 0,",
        "            Scene = 1,",
        "            CubeMap = 2",
        "        }",
        "        //<<< _inputids",
        "",
        "        bool _firstEval = true;",
        "        public override OperatorPartContext Eval(OperatorPartContext context, List<OperatorPart> inputs, int outputIdx)",
        "        {",
        "            //>>> _params",
        "            var Code = inputs[(int)InputId.Code].Eval(context).Text;",
        "            var Scene = inputs[(int)InputId.Scene];",
        "            var CubeMap = inputs[(int)InputId.CubeMap].Eval(context).Image; // Needs to be checked for null!",
        "            //<<< _params",
        "",
        "            if (_firstEval)",
        "            {",
        "                for (int i = 0; i < NumCodes(); ++i)",
        "                    Compile(i);",
        "                _firstEval = false;",
        "                Changed = true;",
        "            }",
        "           ",
        "            using (var CubeMapView = new ShaderResourceView(context.D3DDevice, CubeMap))",
        "            {",
        "                _effect.GetVariableByName(\"CubeMap\").AsShaderResource().SetResource(CubeMapView);",
        "",
        "                using (new PropertyStasher<OperatorPartContext>(context, \"Effect\", \"Renderer\"))",
        "                {",
        "                    context.Effect = _effect;",
        "                    context.Renderer = _renderer;",
        "         ",
        "                    Scene.Eval(context);",
        "                }",
        "            }",
        "            return context;",
        "        }",
        "",
        "        private Renderer _renderer = new Renderer();",
        "    }",
        "}",
        "",
        "",
        ""
      ],
      "AdditionalAssemblies": []
    }
  ],
  "Operators": [],
  "Connections": [
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "edfd87d5-f071-4e5f-9a93-253cf3b69a33",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "7398945f-1172-4fb5-bda7-2c74df79a43c"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "1a8f4e48-1da1-46bc-ae14-91d076706655",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "edfd87d5-f071-4e5f-9a93-253cf3b69a33"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "60743440-8ff4-4d82-8f17-789589dbd867",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "edfd87d5-f071-4e5f-9a93-253cf3b69a33"
    },
    {
      "SourceOp": "00000000-0000-0000-0000-000000000000",
      "SourceOpPart": "5a42be40-93c0-4a0d-9bf8-000ad6f0610f",
      "TargetOp": "00000000-0000-0000-0000-000000000000",
      "TargetOpPart": "edfd87d5-f071-4e5f-9a93-253cf3b69a33"
    }
  ]
}